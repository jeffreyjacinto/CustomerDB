<html>
	<head>
	{% if title %}
		<title>{{ title }} - Tropicana</title>
	{% else %}
		<title>Tropicana</title>
	{% endif %}

		<link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link href="/static/css/bootstrap-formhelpers.min.css" rel="stylesheet" media="screen">
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
		<script src="/static/js/bootstrap.min.js"></script>
		<script src="/static/js/bootstrap-formhelpers.min.js"></script>
		<script src="/static/js/bootstrap-formhelpers-datepicker.en_US.js"></script>
		<script src="/static/js/bootstrap-formhelpers-datepicker.js"></script>
		<script src="/static/js/bootstrap-formhelpers-phone.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script>
			$(function(){
					function fieldlist_add() {        // define event handler
							var $this   = $(this),
									fieldlist = $this.parent().find('.fieldlist').first(),
									fieldlist_proto = $this.find('.fieldlist-prototype').first(),
									fieldlist_proto_groups = fieldlist_proto.find('.form-group');

							fieldlist.append(fieldlist_proto.clone().removeClass('fieldlist-prototype').addClass('fieldlist-entry'));
							fieldlist_proto_groups.each(function() {
								var labels = $(this).find('.control-label'),
										form_fields = $(this).find('.form-control');

								labels.each(function() {
									var $this = $(this),
											for_string = $this.attr('for');

									for_string = for_string.replace(/(\_field\-)(\d+)(\-)/,
										function(fullMatch, pre, n, post) {
											return pre + (Number(n) + 1) + post;
										});

									$this.attr('for', for_string);
								});

								form_fields.each(function() {
									var $this = $(this),
											id = $this.attr('id'),
											name = $(this).attr('name');

									if (id) {
										id = id.replace(/(\_field\-)(\d+)(\-)/, function(fullMatch, pre, n, post) {
												return pre + (Number(n) + 1) + post;
										});
									}
									
									name = name.replace(/(\_field\-)(\d+)(\-)/,
										function(fullMatch, pre, n, post) {
											return pre + (Number(n) + 1) + post;
										});

									$this.attr({'id': id, 'name': name});
								});
							});
					}

					function add_alert(message, category) {
						$('#container-alert').append('<div class="alert alert-' + category + ' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' + message + '</div>')
					}

					$('.fieldlist-add').click(fieldlist_add);  // attach event handler
					$('.order-form').submit(function(event) {  // clean up prototypes
						var $form = $(this),
								toEdit = $form.attr('toEdit'),
								action = $form.attr('action');

						$('.fieldlist-prototype').find('input,select').attr('disabled', 'disabled');
						if (toEdit == 'true') {
							event.preventDefault();
							$.ajax({
								type: "POST",
								url: action,
								data: $form.serialize(),
								success: function () {
									$('.fieldlist-prototype').find('input,select').removeAttr('disabled');
									add_alert('Order edited', 'success');
								},
								fail: function () {
									$('.fieldlist-prototype').find('input,select').removeAttr('disabled');
									add_alert('Order edit failed', 'danger');
								}
							});
						}
					});
					$('.collapse-control').click(function() {
						var $this = $(this),
								collapsables = $this.parent().find('.collapse'),
								target = $($this.attr('data-target')).first();

						collapsables = collapsables.collapse('hide');
						target.collapse('toggle');
					});

					$('.items').on("change", ".item_price", function() {
						var $this = $(this),
								fieldlist = $this.closest('.items'),
								sum = 0;
						fieldlist.find(".item_price").each(function() {
							sum += +$(this).val();
						});
						$this.closest('.order-form').find(".price-total").val(sum).change();
					});

					$('.items').on("change", ".item_quantity", function() {
						var $this = $(this),
								fieldlist = $this.closest('.items'),
								sum = 0;
						fieldlist.find(".item_quantity").each(function() {
							sum += +$(this).val();
						});
						$this.closest('.order-form').find(".pieces-total").val(sum);
					});

					$('.transactions').on("change", ".transaction_amount", function() {
						var $this = $(this),
								fieldlist = $this.closest('.transactions'),
								sum = 0;
						fieldlist.find(".transaction_amount").each(function() {
							sum += +$(this).val();
						});
						$this.closest('.order-form').find(".paid-total").val(sum).change();
					});

					$('.paid-total').change(function() {
						var $this = $(this),
								sumPrice = +$('.sum-price').first().val(),
								sum = 0;
						$('.paid-total').each(function() {
							sum += +$(this).val();
						});
						$('.sum-paid').val(sum);
						$('.sum-balance').val(sum - sumPrice);
					});

					$('.price-total').change(function() {
						var $this = $(this),
								sumPaid = +$('.sum-paid').first().val(),
								sum = 0;
						$('.price-total').each(function() {
							sum += +$(this).val();
						});
						$('.sum-price').val(sum);
						$('.sum-balance').val(sumPaid - sum);
					});

					function payAll() {
						var orderForm = $(this).closest('.order-form'),
								transactions = orderForm.find('.transactions').first().parent(),
								totalPrice = +orderForm.find('.price-total').first().val(),
								totalPaid = +orderForm.find('.paid-total').first().val();

						if (totalPrice - totalPaid > 0) {
							transactions.find('.fieldlist-add').click();
							transactions.find('.fieldlist-entry').last().find('.transaction_amount').val(totalPrice - totalPaid).change();
						}
					}

					$('.pay-all').click(payAll);
			});
		</script>

		<style>
			body {
				padding-top: 4rem;
			}

			h1 {
				padding-bottom: 2rem;
			}

			caption {
				caption-side: top;
			}

			.fixed-top {
					position: fixed;
					top: 0;
					right: 0;
					left: 0;
					z-index: 1030;
			}

			.center {
				padding-top: 3rem;
				margin: 0 auto;
				width: 60%;
			}

			label {
				font-weight: bold;
			}

			.row .form-group .form-control {
				margin: 0;
			}

			.fieldlist-prototype {
				display: none;
			}

			.form-group.col-sm-2 {
				padding: 0;
			}

			.table-info input {
				border: none;
			}
		</style>
	</head>

	<body>
		{% set active_page = active_page|default('index') %}
		<nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse fixed-top">
		<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<a class="navbar-brand" href="{{ url_for('index') }}">Tropicana Dry Cleaners</a>

		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item {% if 'new_order' == active_page %} {{ 'active' }} {% endif %}">
					<a class="nav-link" href="{{ url_for('order') }}">New Order</a>
				</li>
				<li class="nav-item {% if 'find_order' == active_page %} {{ 'active' }} {% endif %}">
					<a class="nav-link" href="{{ url_for('find_orders') }}">Find Order</a>
				</li>
				<li class="nav-item {% if 'find_customer' == active_page %} {{ 'active' }} {% endif %}">
					<a class="nav-link" href="{{ url_for('find_customers') }}">Find Customers</a>
				</li>
			</ul>
		</div>
	</nav>
	{% with messages = get_flashed_messages(with_categories=true) %}
		<!-- Categories: success (green), info (blue), warning (yellow), danger (red) -->
	<div id="container-alert">
	{% if messages %}
		{% for category, message in messages %}
			<div class="alert alert-{{ category }} alert-dismissible" role="alert">
			<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<!-- <strong>Title</strong> --> {{ message }}
			</div>
		{% endfor %}
	{% endif %}
	</div>
	{% endwith %}
	<div class="container-fluid">
		{% block content %}{% endblock %}
	</div>
	</body>
</html>